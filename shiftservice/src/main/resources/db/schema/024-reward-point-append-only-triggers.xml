<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <changeSet id="024-reward-point-append-only-triggers" author="flo" dbms="postgresql">

        <sql>
            CREATE OR REPLACE FUNCTION prevent_reward_point_transaction_changes()
                RETURNS trigger AS
            $$
            BEGIN
                RAISE EXCEPTION 'reward_point_transaction is append-only';
            END;
            $$ LANGUAGE plpgsql;
        </sql>

        <sql>
            DROP TRIGGER IF EXISTS rpt_no_update ON reward_point_transaction;
            CREATE TRIGGER rpt_no_update
                BEFORE UPDATE
                ON reward_point_transaction
                FOR EACH ROW
            EXECUTE FUNCTION prevent_reward_point_transaction_changes();
        </sql>

        <sql>
            DROP TRIGGER IF EXISTS rpt_no_delete ON reward_point_transaction;
            CREATE TRIGGER rpt_no_delete
                BEFORE DELETE
                ON reward_point_transaction
                FOR EACH ROW
            EXECUTE FUNCTION prevent_reward_point_transaction_changes();
        </sql>

    </changeSet>

</databaseChangeLog>
