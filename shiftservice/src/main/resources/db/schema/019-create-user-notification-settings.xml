<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">


  <changeSet id="019-create-user-notification-settings" author="paul">

    <createTable tableName="notification_settings">
      <column name="id" type="BIGINT" autoIncrement="true">
        <constraints primaryKey="true" nullable="false"/>
      </column>

      <column name="user_id" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>

      <column name="notification_type" type="VARCHAR(50)">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <addUniqueConstraint
      tableName="notification_settings"
      columnNames="user_id, notification_type"
      constraintName="uk_notification_settings_user_type"/>

  </changeSet>

  <changeSet id="019-create-user-notification-settings-channels" author="paul">

    <createTable tableName="notification_setting_channels">
      <column name="setting_id" type="BIGINT">
        <constraints nullable="false"/>
      </column>

      <column name="channel" type="VARCHAR(20)">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <!-- FK to notification_settings -->
    <addForeignKeyConstraint
      constraintName="fk_setting_channels_setting"
      baseTableName="notification_setting_channels"
      baseColumnNames="setting_id"
      referencedTableName="notification_settings"
      referencedColumnNames="id"
      onDelete="CASCADE"/>

    <!-- Prevent duplicate channels -->
    <addUniqueConstraint
      tableName="notification_setting_channels"
      columnNames="setting_id, channel"
      constraintName="uk_setting_channels_unique"/>

  </changeSet>

</databaseChangeLog>
